// Enhanced storage for dynamic demo with session persistence
// In production, this should connect to your actual database
import type { User, LogEntry, Machine, Handover, Alert, Shift, InsertLogEntry, InsertHandover } from './types';

// In-memory storage for demo persistence across multiple users
let dynamicLogEntries: LogEntry[] = [];
let dynamicHandovers: Handover[] = [];
let dynamicMachines: Machine[] = [];

// Initialize with base demo data
const initializeDemoData = () => {
  if (dynamicLogEntries.length === 0) {
    dynamicLogEntries = [...getInitialLogEntries()];
  }
  if (dynamicHandovers.length === 0) {
    dynamicHandovers = [...getInitialHandovers()];
  }
  if (dynamicMachines.length === 0) {
    dynamicMachines = [...getInitialMachines()];
  }
};

// Initialize demo data
initializeDemoData();

// Mock data for demonstration - replace with actual database calls
export const apiStorage = {
  async getUserByUsername(username: string): Promise<User | null> {
    // Manufacturing shift personnel with role-based access
    const users = [
      {
        id: '1',
        username: 'press.operator',
        password: 'admin', // In production, this should be hashed
        role: 'Press Operator',
        fullName: 'Jean-Marc Dubois',
        department: 'Press Shop'
      },
      {
        id: '2',
        username: 'body.supervisor',
        password: 'admin',
        role: 'Body Shop Supervisor',
        fullName: 'Marie Leclerc',
        department: 'Body Shop'
      },
      {
        id: '3',
        username: 'paint.operator',
        password: 'admin',
        role: 'Paint Operator',
        fullName: 'Pierre Moreau',
        department: 'Paint Shop'
      },
      {
        id: '4',
        username: 'assembly.lead',
        password: 'admin',
        role: 'Assembly Team Lead',
        fullName: 'Sophie Martin',
        department: 'Assembly Shop'
      },
      {
        id: '5',
        username: 'quality.inspector',
        password: 'admin',
        role: 'Quality Inspector',
        fullName: 'Ahmed Benali',
        department: 'Quality (VQA/IHQA/PTQA)'
      },
      {
        id: '6',
        username: 'maintenance.tech',
        password: 'admin',
        role: 'Maintenance Technician',
        fullName: 'Carlos Rodriguez',
        department: 'Maintenance'
      },
      {
        id: '7',
        username: 'safety.officer',
        password: 'admin',
        role: 'Safety Officer',
        fullName: 'Anna Kowalski',
        department: 'Safety & Environment'
      },
      {
        id: '8',
        username: 'shift.manager',
        password: 'admin',
        role: 'Shift Manager',
        fullName: 'Thomas Schneider',
        department: 'Manufacturing'
      }
    ];
    
    return users.find(user => user.username === username) || null;
  },

  async getShifts(): Promise<Shift[]> {
    // Current active shifts for demo - using current dates
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    return [
      {
        id: '1',
        shiftName: 'Morning Shift (06:00-14:00)',
        startTime: new Date(today.getTime() + 6 * 60 * 60 * 1000), // 6 AM today
        endTime: new Date(today.getTime() + 14 * 60 * 60 * 1000), // 2 PM today
        supervisorId: '2', // Body Shop Supervisor
        operatorId: '1', // Press Operator
        status: 'Active'
      },
      {
        id: '2',
        shiftName: 'Afternoon Shift (14:00-22:00)',
        startTime: new Date(today.getTime() + 14 * 60 * 60 * 1000), // 2 PM today
        endTime: new Date(today.getTime() + 22 * 60 * 60 * 1000), // 10 PM today
        supervisorId: '4', // Assembly Team Lead
        operatorId: '3', // Paint Operator
        status: 'Scheduled'
      },
      {
        id: '3',
        shiftName: 'Night Shift (22:00-06:00)',
        startTime: new Date(today.getTime() + 22 * 60 * 60 * 1000), // 10 PM today
        endTime: new Date(today.getTime() + 30 * 60 * 60 * 1000), // 6 AM next day
        supervisorId: '8', // Shift Manager
        operatorId: '6', // Maintenance Tech
        status: 'Scheduled'
      }
    ];
  },

  async getCurrentShift(): Promise<Shift | null> {
    // Always return the active shift for demo purposes
    const shifts = await this.getShifts();
    // Find active shift or return the first one as fallback
    return shifts.find(shift => shift.status === 'Active') || shifts[0] || null;
  },

  async getLogEntries(): Promise<LogEntry[]> {
    initializeDemoData();
    // Return combined static and dynamic entries, sorted by timestamp
    return [...dynamicLogEntries].sort((a, b) => 
      new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
    );
  },

  async getLogEntriesByShift(shiftId: string): Promise<LogEntry[]> {
    const entries = await this.getLogEntries();
    return entries.filter(entry => entry.shiftId === shiftId);
  },

  async createLogEntry(entry: InsertLogEntry): Promise<LogEntry> {
    initializeDemoData();
    const newEntry: LogEntry = {
      id: `dynamic-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      ...entry
    };
    dynamicLogEntries.unshift(newEntry); // Add to beginning for latest first
    return newEntry;
  },

  async getMachines(): Promise<Machine[]> {
    initializeDemoData();
    return [...dynamicMachines];
  },

  async updateMachine(id: string, updates: Partial<Machine>): Promise<Machine | null> {
    // TODO: Replace with actual database update
    const machines = await this.getMachines();
    const machine = machines.find(m => m.id === id);
    if (!machine) return null;
    return { ...machine, ...updates };
  },

  async getHandovers(): Promise<Handover[]> {
    initializeDemoData();
    return [...dynamicHandovers].sort((a, b) => 
      new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
    );
  },

  async getPendingHandovers(): Promise<Handover[]> {
    // TODO: Replace with actual database query
    const handovers = await this.getHandovers();
    return handovers.filter(h => h.status === 'pending');
  },

  async createHandover(handover: InsertHandover): Promise<Handover> {
    // TODO: Replace with actual database insert
    return {
      id: Date.now().toString(),
      ...handover
    };
  },

  async updateHandover(id: string, updates: Partial<Handover>): Promise<Handover | null> {
    initializeDemoData();
    const handoverIndex = dynamicHandovers.findIndex(h => h.id === id);
    if (handoverIndex === -1) return null;
    
    dynamicHandovers[handoverIndex] = { ...dynamicHandovers[handoverIndex], ...updates };
    return dynamicHandovers[handoverIndex];
  },

  async getAlerts(): Promise<Alert[]> {
    // TODO: Replace with actual database query
    return [];
  },

  async getActiveAlerts(): Promise<Alert[]> {
    // TODO: Replace with actual database query
    const alerts = await this.getAlerts();
    return alerts.filter(alert => !alert.resolved);
  },

  async createAlert(message: string, severity: string): Promise<Alert> {
    // TODO: Replace with actual database insert
    return {
      id: Date.now().toString(),
      message,
      severity,
      timestamp: new Date(),
      resolved: false
    };
  },

  async resolveAlert(id: string): Promise<void> {
    // TODO: Replace with actual database update
    console.log(`Alert ${id} resolved`);
  }
};

// Helper function to get initial log entries
function getInitialLogEntries(): LogEntry[] {
  return [
    // Press Shop (Stamping) Operations
    {
      id: '1',
      shiftId: '1',
      userId: '1',
      taskDescription: 'Press Shop Line 1 - Steel coil changeover completed',
      remarks: 'New coil batch #PS-2025-1105. IHQA dimensional checks passed. Press speed: 15 SPM. Next maintenance due: 2000 cycles.',
      timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
      priority: 'High',
      status: 'Completed',
      department: 'Press Shop',
      area: 'Stamping Line 1'
    },
    {
      id: '2',
      shiftId: '1',
      userId: '2',
      taskDescription: 'Press Shop - Quality inspection results',
      remarks: 'IHQA: 95 panels inspected. Surface finish: 98.5% pass rate. 2 panels rejected for minor scratches. Jig recalibration completed.',
      timestamp: new Date(Date.now() - 1.5 * 60 * 60 * 1000),
      priority: 'Medium',
      status: 'Completed',
      department: 'Press Shop',
      area: 'Quality Control'
  async createHandover(handover: InsertHandover): Promise<Handover> {
    initializeDemoData();
    const newHandover: Handover = {
      id: `handover-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      ...handover
    };
    dynamicHandovers.unshift(newHandover); // Add to beginning for latest first
    return newHandover;
  },  userId: '3',
      taskDescription: 'Body Shop - Robotic welding station maintenance',
      remarks: 'Robot #BS-R12 welding tips replaced. Jig accuracy verified: ±0.2mm tolerance maintained. 847 weld points completed this shift.',
      timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000),
      priority: 'High',
      status: 'Completed',
      department: 'Body Shop',
      area: 'Robotic Welding'
    },
    {
      id: '4',
      shiftId: '1',
      userId: '3',
      taskDescription: 'Body Shop - BIW geometry check',
      remarks: 'Body-in-White dimensional verification: 12 units checked. All within specification. CMM measurement data logged. Framing jig #3 needs attention.',
      timestamp: new Date(Date.now() - 45 * 60 * 1000),
      priority: 'Medium',
      status: 'In Progress',
      department: 'Body Shop',
      area: 'Quality Inspection'
    },

    // Paint Shop Operations
    {
      id: '5',
      shiftId: '1',
      userId: '4',
      taskDescription: 'Paint Shop - Environmental controls adjustment',
      remarks: 'Temperature: 22°C, Humidity: 65%. PTQA paint adhesion tests: 99.1% pass rate. Booth #2 filters changed. Color match verification completed.',
      timestamp: new Date(Date.now() - 30 * 60 * 1000),
      priority: 'High',
      status: 'Completed',
      department: 'Paint Shop',
      area: 'Paint Booth'
    },
    {
      id: '6',
      shiftId: '1',
      userId: '4',
      taskDescription: 'Paint Shop - Coating process monitoring',
      remarks: 'Pre-treatment: OK, Primer: 25μm thickness, Base coat: Uniform coverage, Clear coat: 45μm. 3 units re-sprayed due to contamination.',
      timestamp: new Date(Date.now() - 20 * 60 * 1000),
      priority: 'Medium',
      status: 'Completed',
      department: 'Paint Shop',
      area: 'Multi-stage Coating'
    },

    // Assembly Shop (TCF) Operations
    {
      id: '7',
      shiftId: '1',
      userId: '5',
      taskDescription: 'Assembly Shop - Trim line operations',
      remarks: 'Interior components fitted: 45 units. Poka-yoke system prevented 3 assembly errors. Dashboard installation: 100% first-pass rate.',
      timestamp: new Date(Date.now() - 15 * 60 * 1000),
      priority: 'Medium',
      status: 'Completed',
      department: 'Assembly Shop',
      area: 'Trim Line'
    },
    {
      id: '8',
      shiftId: '1',
      userId: '5',
      taskDescription: 'Assembly Shop - Chassis torque verification',
      remarks: 'Torque checks: Engine mounts 85Nm, Suspension 120Nm, Wheels 110Nm. All within specification. Torque gun calibration due tomorrow.',
      timestamp: new Date(Date.now() - 10 * 60 * 1000),
      priority: 'High',
      status: 'Completed',
      department: 'Assembly Shop',
      area: 'Chassis Line'
    },
    {
      id: '9',
      shiftId: '1',
      userId: '6',
      taskDescription: 'Final Assembly - Quality gate inspection',
      remarks: 'Final inspection: 52 vehicles completed. VQA approval: 98.1%. 1 unit held for electrical fault. End-of-line test results logged.',
      timestamp: new Date(Date.now() - 5 * 60 * 1000),
      priority: 'High',
      status: 'Completed',
      department: 'Assembly Shop',
      area: 'Final Line'
    },

    // Maintenance & Safety Operations
    {
      id: '10',
      shiftId: '1',
      userId: '7',
      taskDescription: 'Predictive maintenance - Press Shop',
      remarks: 'Vibration analysis completed on Press #1. Bearing replacement scheduled for next weekend. Oil analysis: within normal parameters.',
      timestamp: new Date(Date.now() - 3 * 60 * 1000),
      priority: 'Medium',
      status: 'Completed',
      department: 'Maintenance',
      area: 'Predictive Maintenance'
    },
    {
      id: '11',
      shiftId: '1',
      userId: '8',
      taskDescription: 'Safety inspection - Assembly area',
      remarks: 'Safety audit completed. All emergency stops functional. Safety training: 5 operators certified. No incidents reported this shift.',
      timestamp: new Date(),
      priority: 'High',
      status: 'Completed',
      department: 'Safety & Environment',
      area: 'Safety Compliance'
    }
  ];
}

// Helper function to get initial handovers
function getInitialHandovers(): Handover[] {
  return [
    {
      id: '1',
      shiftId: '1',
      fromUserId: '1', // Jean-Marc Dubois (Press Operator)
      toUserId: '2',   // Marie Leclerc (Body Shop Supervisor)
      status: 'pending',
      approvedAt: null,
      remarks: 'Press Shop handover: Line 1 running smoothly, new coil installed. Quality checks passed. Line 2 needs bearing replacement next week.',
      createdAt: new Date(Date.now() - 30 * 60 * 1000),
      department: 'Press Shop',
      area: 'Production Handover'
    },
    {
      id: '2',
      shiftId: '1',
      fromUserId: '2', // Marie Leclerc (Body Shop Supervisor)
      toUserId: '3',   // Pierre Moreau (Paint Operator)
      status: 'approved',
      approvedAt: new Date(Date.now() - 15 * 60 * 1000),
      remarks: 'Body Shop handover: 47 BIW units completed. Robot R12 maintenance done. Jig #3 calibrated. Quality: all dimensional checks passed.',
      createdAt: new Date(Date.now() - 45 * 60 * 1000),
      department: 'Body Shop',
      area: 'Production Handover'
    },
    {
      id: '3',
      shiftId: '1',
      fromUserId: '3', // Pierre Moreau (Paint Operator)
      toUserId: '4',   // Sophie Martin (Assembly Team Lead)
      status: 'pending',
      approvedAt: null,
      remarks: 'Paint Shop handover: Environmental controls optimal. PTQA quality: 99.1% pass rate. 3 units re-sprayed. Booth #2 filters changed.',
      createdAt: new Date(Date.now() - 10 * 60 * 1000),
      department: 'Paint Shop',
      area: 'Production Handover'
    },
    {
      id: '4',
      shiftId: '1',
      fromUserId: '4', // Sophie Martin (Assembly Team Lead)
      toUserId: '5',   // Ahmed Benali (Quality Inspector)
      status: 'pending',
      approvedAt: null,
      remarks: 'Assembly handover: 52 vehicles completed. Torque specifications verified. Poka-yoke system active. Final inspection: 98.1% pass rate.',
      createdAt: new Date(Date.now() - 5 * 60 * 1000),
      department: 'Assembly Shop',
      area: 'Production Handover'
    },
    {
      id: '5',
      shiftId: '1',
      fromUserId: '6', // Carlos Rodriguez (Maintenance Tech)
      toUserId: '8',   // Thomas Schneider (Shift Manager)
      status: 'approved',
      approvedAt: new Date(Date.now() - 20 * 60 * 1000),
      remarks: 'Maintenance handover: Predictive maintenance completed on Press #1. All safety systems verified. No critical issues reported.',
      createdAt: new Date(Date.now() - 60 * 60 * 1000),
      department: 'Maintenance',
      area: 'Maintenance Handover'
    },
    {
      id: '6',
      shiftId: '1',
      fromUserId: '7', // Anna Kowalski (Safety Officer)
      toUserId: '8',   // Thomas Schneider (Shift Manager)
      status: 'pending',
      approvedAt: null,
      remarks: 'Safety handover: All emergency stops functional. 5 operators completed safety training. Environmental compliance checks passed. No incidents.',
      createdAt: new Date(),
      department: 'Safety & Environment',
      area: 'Safety Handover'
    }
  ];
}

// Helper function to get initial machines
function getInitialMachines(): Machine[] {
  return [
    // Press Shop Equipment
    {
      id: '1',
      machineName: 'Press Line 1 - 800T Hydraulic Press',
      status: 'Running',
      uptime: 96.5,
      lastMaintenance: new Date('2025-10-28'),
      department: 'Press Shop',
      area: 'Stamping Line 1'
    },
    {
      id: '2',
      machineName: 'Press Line 2 - 1200T Mechanical Press',
      status: 'Running',
      uptime: 94.2,
      lastMaintenance: new Date('2025-10-25'),
      department: 'Press Shop',
      area: 'Stamping Line 2'
    },
    
    // Body Shop Equipment
    {
      id: '3',
      machineName: 'Robotic Welding Station #BS-R12',
      status: 'Running',
      uptime: 98.1,
      lastMaintenance: new Date('2025-11-01'),
      department: 'Body Shop',
      area: 'Robotic Welding'
    },
    {
      id: '4',
      machineName: 'Framing Jig #3 - BIW Assembly',
      status: 'Maintenance',
      uptime: 87.3,
      lastMaintenance: new Date('2025-11-05'),
      department: 'Body Shop',
      area: 'Manual Assembly'
    },
    
    // Paint Shop Equipment
    {
      id: '5',
      machineName: 'Paint Booth #2 - Automated Spray',
      status: 'Running',
      uptime: 92.8,
      lastMaintenance: new Date('2025-10-30'),
      department: 'Paint Shop',
      area: 'Paint Booth'
    },
    
    // Assembly Shop Equipment
    {
      id: '6',
      machineName: 'Trim Line Conveyor System',
      status: 'Running',
      uptime: 95.7,
      lastMaintenance: new Date('2025-10-26'),
      department: 'Assembly Shop',
      area: 'Trim Line'
    }
  ];
}
